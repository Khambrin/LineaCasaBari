#!/usr/bin/perl -w

use CGI qw(:standard);
use CGI::Cookie;
use CGI::Carp qw(warningsToBrowser fatalsToBrowser);
use strict;
use Template;
use CGI::Session;
use XML::LibXML;
use File::Basename;
use Switch;



my $cgi=new CGI;

my $session = CGI::Session->load();
my $email=$session->param("email");
my $quantita=param("quantita");
my $prodotto=param("codice_prodotto");



my $doc,my $root;
	my $id=0, my $valutazione="";
if (-e "../data/Carrelli.xml")
{
	my $parser=XML::LibXML->new();
	$doc=$parser->parse_file("../data/Carrelli.xml");
	$root=$doc->documentElement();
}
else
{
	$doc=XML::LibXML::Document->new("1.0","UTF-8");
	$root=$doc->createElement("Carrelli");
	$doc->setDocumentElement($root);	
}
my $carrello_esistente=$doc->findnodes("Carrelli/Carrello[Utente='$email']");
if($carrello_esistente=0)
{
	my $carrello_tag=$doc->createElement("Carrello");	
	$root->appendChild($carrello_tag);
	my $id_tag=$doc->createElement("Utente");
	$id_tag->appendTextNode($email);
	$carrello_tag->appendChild($id_tag);
	
	my $element_tag=$doc->createElement("Elemento");
	$carrello_tag->appendChild($element_tag);	
	
	my $prodotto_tag=$doc->createElement("Prodotto");
	$element_tag->appendChild($prodotto_tag);
	$prodotto_tag->appendTextNode($prodotto);
	
	my $quantita_tag=$doc->createElement("Quantita");
	$element_tag->appendChild($quantita_tag);
	$quantita_tag->appendTextNode($quantita);
}
else
{
	my $element_tag=$doc->findnodes("Carrelli/Carrello[Utente='$email']/Elemento");
	my $prodotto_esistente=$doc->findnodes("Carrelli/Carrello[Utente='$email']/Elemento[Prodotto='$prodotto']");
	if($prodotto_esistente=0)
	{
		my $prodotto_tag=$doc->createElement("Prodotto");
		$element_tag->appendChild($prodotto_tag);
		$prodotto_tag->appendTextNode($prodotto);
	
		my $quantita_tag=$doc->createElement("Quantita");
		$element_tag->appendChild($quantita_tag);
		$quantita_tag->appendTextNode($quantita);
	}
	else
	{
		my $quantita_esistente=$doc->findnodes("Carrelli/Carrello[Utente='$email']/Elemento[Prodotto='$prodotto']/Quantita");
		my $somma=$quantita_esistente->string_value;
		$somma=$somma+$quantita;
		
		my $aux = $doc->findnodes("Carrelli/Carrello[Utente='$email']/Elemento[Prodotto='$prodotto']/Quantita");
		my $parent = $aux->[0]->parentNode;
		$parent->removeChild($aux->[0]);
		
		
		my $quantita_tag=$doc->createElement("Quantita");
		$parent->appendChild($quantita_tag);
		$quantita_esistente->appendTextNode($somma);

	}
}
open (XML,">","../data/Carrelli.xml");
print XML $doc->toString();
close(XML);
=pod
print $cgi->redirect("gestione_prodotti_script.cgi?aggiungi");
}
		
=cut
